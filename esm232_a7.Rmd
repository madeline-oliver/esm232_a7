---
title: "ESM 232 Assignment 7"
author: "Madeline Oliver, Alex Ehrens, Siya Qiu"
date: "5/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Rabbits and Hawks Population Matrix Assignment


A small city with a large urban park has decided to introduce a rare species of rabbits into this park - Rabbits are cute and the kids love them, and giving a rare species a new home sounds like a good idea. The urban park manager is concerned about how this rabbit population might grow over the next few decades. Rabbits have no natural predators in the region where the park is situated. The manager would like to know, approximately, how many rabbits there will be 20 years from now if the rabbits are introduced as planned. The manager reviewed the literature and found the following estimates for survival and fertility rates for the rare rabbit population, for 4 different age classes. The estimates for these rates are shown below

# Multiple Time Steps

use function to evolve a population through time
 * inputs = survivability, fertility, initial population, time steps
 * output = final population matrix
 * a dynamic model - difference equations - similar to our diffusion model
 
```{r multitime}

source("evolve_pop2.R")

# fertility rates
f1 = 0.0
f2 = 2/2 # have to divide by two because only women are fertile
f3 = 6/2
f4 = 1/2

# survivability 
p01 = 0.8
p12 = 0.85
p23 = 0.65
p34 = 0.1

# initial population parameters
ini = c(0,0,10,0) 
ndecades = 2
fert_rabbits = c(f1,f2,f3,f4)
surv_rabbits = c(p01,p12,p23,p34)
rabbit_pop=evolve_pop2(fert_rabbits, surv_rabbits, ini, ndecades)

head(rabbit_pop)

# graph different components of the output
# total population

# add decade 
#decade = seq(from=1, to=ndecades)
#china_tot = cbind.data.frame(decade=decade, poptot=china_pop$poptot)
#ggplot(china_tot, aes(decade, poptot))+geom_col()+labs(y="Total Popultation")

# plot information about ages
#china_ages = cbind.data.frame(decade=decade, t(china_pop$popbyage))
#china_agesl = china_ages %>% gather(key="agecat", value="pop",-decade)
#ggplot(china_agesl, aes(decade, pop, fill=agecat))+geom_col()+labs(y="Population", fill="Age Group")

```
 
### Result:

After 20 years and an initial population of 10 adult (age 2-3) rabbits, there are 36.5 rabbits in the total population, with 30 rabbits in the young (0-1) age class.

### Sobel sensitivity analysis

Now lets use Sobel to explore how our intervention might impact the population...

AND account for uncertainty in some of our parameters

Reminder
Sobel sensitivity analysis Breaks variance of output into 

* variance associated directly with parameter alone (fraction associated with each parameter, sum to 1)
* variance associated with parameter and interaction with other parameters (sum can be more than 1)

Steps

* run sobel to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from sobel
```{r sobel}

library(sensitivity)

# survivability 
nsample=200

#p01 = 0.8
#p12 = 0.85
#p23 = 0.65
#p34 = 0.1

# create our two samples for Sobel
# first do our survivability
ps1 = cbind.data.frame(p01 = runif(min=0.65, max=0.75, n=nsample), 
                       p12 = runif(min=0.75, max=0.8, n=nsample),
                       p23 = runif(min=0.65, max=0.65, n=nsample),
                       p34 = runif(min=0.1, max=0.1, n=nsample))

ps2 = cbind.data.frame(p01=runif(min=0.65, max=0.75, n=nsample), 
                       p12 = runif(min=0.75, max=0.8, n=nsample),
                       p23 = runif(min=0.65, max=0.65, n=nsample),
                       p34 = runif(min=0.1, max=0.1, n=nsample))

# then fertility
fs1 = cbind.data.frame(f1=0, 
                       f2 = 1,
                       f3 = 3,
                       f4 = 3)


# put survivability and fertility together
allp1 = cbind.data.frame(ps1,fs1)
allp2 = cbind.data.frame(ps2,fs1)

# get sobel samples
sens_rabbit=soboljansen(model = NULL, allp1, allp2, nboot = 100)

head(sens_rabbit$X)
nsim=nrow(sens_rabbit$X)

# run model and save what we care about: final population after 20 years
# this is already output by evolve_pop so we don't need a compute_metric function

ini = c(0,0,10,0)
ndecades= c(2)

# as before combine our application of the the dynamics model - for each
# parameter set, with code to extract our metric of interest (final population)
p_wrapper = function(p01, p12, p23, p34, f1,f2,f3,f4,use_func, initialpop, nstep ) {
  fertility=c(f1,f2,f3,f4)
  survivability= c(p01,p12,p23,p34)
  res = use_func(survivability =survivability, fertility = fertility, initialpop=initialpop, nstep=nstep)
# now return the final population total
  return(finalpop=res$poptot[nstep])
}

# use pmap here so we can specify rows of our sensitivity analysis parameter object 
res = as.data.frame(sens_rabbit$X) %>% 
  pmap_dbl(p_wrapper, initialpop=ini, nstep=ndecades, use_func=evolve_pop2)
         
view(res) 

# plot results (variation in final population across all parameter)
# ggplot needs a dataframe - so do a quick conversion with data.frame
ggplot(data.frame(finalpop=res), 
       aes(x=finalpop))+
  geom_density()

# or a boxplot
ggplot(data.frame(finalpop=res), 
       aes(x="", y=finalpop) )+
  geom_boxplot(fill="blue")+
  theme(axis.title.x = element_blank())+
  labs(y="Final Population")

# give our results to sensitivity structure
sens_rabbit=tell(sens_rabbit, res)

# loot at results
sens_rabbit$S
sens_rabbit$T

# graph the most sensitive parameter
tmp = cbind.data.frame(sens_rabbit$X, 
                       pop12=sens_rabbit$y)

ggplot(tmp, aes(p12, pop12))+
  geom_point()+
  labs(x="Survivability of 1 to older",
       y="pop after 20 years")
```


